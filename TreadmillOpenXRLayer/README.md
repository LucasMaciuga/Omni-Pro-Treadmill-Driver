# TreadmillOpenXRLayer

OpenXR API Layer für Omni Pro Treadmill Input-Injection in VR-Spiele.

## Funktionsweise

Dieser API Layer wird vom OpenXR Loader automatisch geladen und injiziert Treadmill-Daten in alle OpenXR-Anwendungen.

```
???????????????????????????????????????????????????????????????????????????????
?  VR ANWENDUNG (The Midnight Walk, UEVR, etc.)                              ?
?  Ruft OpenXR-Funktionen auf                                                ?
???????????????????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????????????????
?  OPENXR LOADER (openxr_loader.dll)                                         ?
?  Lädt API Layers in Reihenfolge                                            ?
???????????????????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????????????????
?  TREADMILL LAYER (TreadmillOpenXRLayer.dll)                                ?
?  ??? Intercepts xrGetActionStateVector2f()                                 ?
?  ??? Intercepts xrGetActionStateFloat()                                    ?
?  ??? Injiziert Treadmill X/Y in Bewegungs-Actions                         ?
???????????????????????????????????????????????????????????????????????????????
                             ?
                             ?
???????????????????????????????????????????????????????????????????????????????
?  OPENXR RUNTIME (SteamVR, Oculus, WMR)                                     ?
?  Kommuniziert mit VR-Hardware                                              ?
???????????????????????????????????????????????????????????????????????????????
```

## Installation

### Automatisch (Registry)

1. Führe `install.bat` als Administrator aus

   Oder manuell:

2. Kopiere alle Dateien in einen permanenten Ordner:
   ```
   C:\Program Files\TreadmillOpenXRLayer\
   ??? TreadmillOpenXRLayer.dll
   ??? XR_APILAYER_NOVENDOR_treadmill_locomotion.json
   ??? OmniBridge.dll
   ??? treadmill_layer_config.json
   ```

3. Registriere den Layer in der Registry:
   ```
   Windows Registry Editor Version 5.00

   [HKEY_LOCAL_MACHINE\SOFTWARE\Khronos\OpenXR\1\ApiLayers\Implicit]
   "C:\\Program Files\\TreadmillOpenXRLayer\\XR_APILAYER_NOVENDOR_treadmill_locomotion.json"=dword:00000000
   ```

### Deaktivieren/Aktivieren

- **Deaktivieren**: Setze Environment Variable `DISABLE_TREADMILL_LAYER=1`
- **Aktivieren**: Setze Environment Variable `ENABLE_TREADMILL_LAYER=1` (überschreibt Disable)

## Konfiguration

Bearbeite `treadmill_layer_config.json`:

```json
{
    "enabled": true,
    "comPort": "COM3",
    "speedMultiplier": 1.5,
    "deadzone": 0.1,
    "smoothing": 0.3,
    "inputMode": "smart",
    "actionPatterns": ["*move*", "*locomotion*"],
    "targetPaths": ["/user/hand/left/input/thumbstick"],
    "debugLog": true
}
```

### Input-Modi

- **override**: Treadmill ersetzt Controller-Input
- **additive**: Treadmill + Controller werden kombiniert
- **smart**: Treadmill überschreibt nur wenn aktiv (empfohlen)

## Unterstützte Spiele/Anwendungen

| Anwendung | Status | Hinweise |
|-----------|--------|----------|
| The Midnight Walk | ? | OpenXR nativ |
| UEVR (alle Spiele) | ? | UEVR nutzt OpenXR |
| Half-Life: Alyx | ? | OpenXR nativ |
| Beat Saber (neu) | ? | OpenXR-Modus |
| Bonelab | ? | OpenXR nativ |
| Into the Radius | ? | OpenXR nativ |

## UEVR-Spezifisches

UEVR (Universal Unreal Engine VR) verwendet OpenXR. Der Layer funktioniert automatisch mit allen UEVR-Spielen:

1. Installiere UEVR wie gewohnt
2. Installiere diesen Layer
3. Starte das Spiel mit UEVR
4. Treadmill-Input wird automatisch injiziert

**Bekannte UEVR-kompatible Spiele:**
- Hogwarts Legacy
- Elden Ring
- Cyberpunk 2077
- Resident Evil 4 (2023)
- und viele mehr...

## Debugging

Das Log wird in `treadmill_layer.log` im Layer-Ordner geschrieben.

Wichtige Log-Einträge:
```
[OK] Layer negotiation successful
[OK] Treadmill connected successfully!
[OK] Movement action created: move (type=2)
[OK] Injected Vector2f: X=0.500 Y=0.750
```

## Deinstallation

1. Lösche den Registry-Eintrag:
   ```
   reg delete "HKLM\SOFTWARE\Khronos\OpenXR\1\ApiLayers\Implicit" /v "C:\Program Files\TreadmillOpenXRLayer\XR_APILAYER_NOVENDOR_treadmill_locomotion.json" /f
   ```

2. Lösche den Ordner `C:\Program Files\TreadmillOpenXRLayer\`

## Build

Benötigt:
- Visual Studio 2022
- Windows SDK 10.0
- C++20

```bash
# In Visual Studio
# Öffne TreadmillOpenXRLayer.sln
# Build -> Build Solution (x64 Release)
```

## Dateien

| Datei | Beschreibung |
|-------|--------------|
| `layer_main.cpp` | Layer Entry, xrNegotiateLoaderApiLayerInterface |
| `openxr_layer.h` | OpenXR Typen und Layer-Deklarationen |
| `openxr_interceptor.cpp` | xrGetActionState* Interception |
| `treadmill_input.h/cpp` | OmniBridge-Integration |
| `XR_APILAYER_*.json` | Layer-Manifest für OpenXR Loader |
| `treadmill_layer_config.json` | Konfigurationsdatei |
